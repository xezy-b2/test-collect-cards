<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Collection Personnelle</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Variables du Th√®me Sombre */
        :root {
            /* Couleurs Raret√© (claires pour ressortir, bas√©es sur cards.html) */
            --color-RareHoloEX: #ff7675; /* Rouge clair */
            --color-RareHolo: #a29bfe;   /* Mauve clair */
            --color-Rare: #fdcb6e;       /* Jaune/Orange */
            --color-ArcEnCiel: #74b9ff;   /* Bleu clair */
            --color-Gold: #55efc4;     /* Vert mint */
            
            --main-bg-color: #1c1c1c;    /* Gris tr√®s fonc√© */
            --header-color: #f0f0f0;     /* Texte blanc cass√© */
            --menu-bg-color: #2c2c2c;
            --accent-color: #74b9ff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            background-color: var(--main-bg-color);
            color: var(--header-color);
            min-height: 100vh;
        }

        /* ------------------ MENU BURGER ------------------ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--menu-bg-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 20;
            position: relative; 
        }

        .logo a {
            color: var(--header-color);
            text-decoration: none;
            font-size: 1.5em;
            font-weight: 700;
        }

        .menu-list {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }

        .menu-list li {
            margin-left: 30px;
        }

        .menu-list a {
            color: var(--header-color);
            text-decoration: none;
            font-size: 1em;
            transition: color 0.3s;
        }

        .menu-list a:hover {
            color: var(--accent-color);
        }

        /* Styles pour mobile (menu burger) */
        .burger-icon {
            display: none; 
            cursor: pointer;
            z-index: 30;
        }

        .burger-icon .bar {
            width: 25px;
            height: 3px;
            background-color: var(--header-color);
            margin: 5px 0;
            transition: 0.4s;
        }

        @media (max-width: 768px) {
            .menu-list {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px; 
                left: 0;
                width: 100%;
                background-color: var(--menu-bg-color);
                box-shadow: 0 10px 10px rgba(0, 0, 0, 0.3);
                z-index: 10;
                padding: 20px 0;
            }

            .menu-list.open {
                display: flex;
            }

            .menu-list li {
                margin: 10px 0;
                text-align: center;
            }
            
            .burger-icon {
                display: block; 
            }
        }
        
        /* ------------------ CONTENU PRINCIPAL ------------------ */

        .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .search-form input, .search-form button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
        }

        .search-form input {
            background-color: #333;
            color: var(--header-color);
            border: 2px solid var(--accent-color);
        }

        .search-form button {
            background-color: var(--accent-color);
            color: var(--main-bg-color);
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-form button:hover {
            background-color: #5aa8ff;
        }

        #status-message {
            text-align: center;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        /* ------------------ AFFICHAGE DES CARTES ------------------ */

        #card-collection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .card-container {
            position: relative;
            background-color: #2c2c2c; 
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .card-container:hover {
            transform: translateY(-5px);
        }

        .card-image {
            width: 100%;
            padding-top: 100%; 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .card-info h3 {
            margin: 5px 0 2px 0;
            font-size: 1.1em;
            color: var(--header-color);
        }

        .card-info p {
            margin: 0;
            font-size: 0.9em;
            color: #aaa;
        }

        .card-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--accent-color);
            color: var(--main-bg-color);
            padding: 5px 10px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.8em;
            z-index: 10;
            border: 2px solid white;
        }
        
        /* Styles de Raret√© (utilisent la classe nettoy√©e, ex: RareHoloEX) */
        .card-container.RareHoloEX {
            border: 4px solid var(--color-RareHoloEX);
            box-shadow: 0 0 15px var(--color-RareHoloEX);
        }
        .card-container.RareHolo {
            border: 4px solid var(--color-RareHolo);
            box-shadow: 0 0 10px var(--color-RareHolo);
        }
        .card-container.Rare {
            border: 4px solid var(--color-Rare);
        }
        .card-container.ArcEnCiel {
            border: 4px solid var(--color-ArcEnCiel);
        }
        .card-container.Gold {
            border: 4px solid var(--color-Gold);
        }

    </style>
</head>
<body>
    <header class="header">
        <div class="logo"><a href="index.html">TCG Bot</a></div>
        <div class="burger-icon" id="burger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <ul class="menu-list" id="menu">
            <li><a href="index.html">Accueil</a></li>
            <li><a href="cards.html">Cartes √† Collectionner (151)</a></li>
            <li><a href="mycollection.html">Mes Cartes (Collection Personnelle)</a></li>
        </ul>
    </header>
    <div class="content">
        <h1>Ma Collection Personnelle</h1>

        <div class="search-form">
            <input type="text" id="username-input" placeholder="Entrez votre nom Twitch..." />
            <button id="load-collection-btn">Charger ma collection</button>
        </div>

        <p id="status-message">Entrez votre nom Twitch pour voir les cartes que vous avez tir√©es.</p>

        <div id="card-collection">
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // Votre objet de configuration copi√© depuis Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAL5PZdkeN_Vo7PY2z3vT6VV79pkDuQLhE",
  authDomain: "tcg-bot-24e10.firebaseapp.com",
  projectId: "tcg-bot-24e10",
  storageBucket: "tcg-bot-24e10.firebasestorage.app",
  messagingSenderId: "825599190047",
  appId: "1:825599190047:web:006b01f7068909a1d8a12a"
};

        // Initialisation de Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        let ALL_CARDS_DATA = [];
        let cardCatalogMap = {};
        let TOTAL_UNIQUE_CARDS = 0; // üëà NOUVEAU : Variable pour stocker le total unique

        document.addEventListener('DOMContentLoaded', () => {
            const usernameInput = document.getElementById('username-input');
            const loadCollectionBtn = document.getElementById('load-collection-btn');
            const statusMessage = document.getElementById('status-message');
            const cardCollectionDiv = document.getElementById('card-collection');

            // --- 1. CHARGEMENT DU CATALOGUE COMPLET (POK√âMON) ---
            async function loadCardCatalog() {
                try {
                    // Cherche cards.json, le fichier Pok√©mon
                    const response = await fetch('/test-collect-cards/cards.json'); 
                    if (!response.ok) throw new Error('Fichier de catalogue cards.json non trouv√©.');
                    
                    ALL_CARDS_DATA = await response.json();
                    
                    // üö® D√âFINITION DU TOTAL UNIQUE DE CARTES üö®
                    TOTAL_UNIQUE_CARDS = ALL_CARDS_DATA.length;

                    // Indexer pour la recherche par ID
                    ALL_CARDS_DATA.forEach((card, index) => {
                        // Assure que l'ID est d√©fini, comme le bot le fait
                        const cardId = card.id || String(index + 1); 
                        cardCatalogMap[cardId] = { ...card, id: cardId };
                    });
                    console.log(`Catalogue complet charg√© : ${Object.keys(cardCatalogMap).length} cartes.`);
                    return true;
                } catch (error) {
                    console.error("Erreur lors du chargement du catalogue:", error);
                    statusMessage.textContent = `Erreur: Impossible de charger le fichier de cartes (cards.json).`;
                    return false;
                }
            }
            
            loadCardCatalog();


            // --- 2. FONCTION DE CHARGEMENT DE LA COLLECTION UTILISATEUR ---
            loadCollectionBtn.addEventListener('click', () => {
                const username = usernameInput.value.trim().toLowerCase();
                if (!username) {
                    statusMessage.textContent = "Veuillez entrer votre nom Twitch.";
                    return;
                }

                if (TOTAL_UNIQUE_CARDS === 0) { // V√©rifie la variable charg√©e
                    statusMessage.textContent = "Catalogue de cartes en cours de chargement ou introuvable. Veuillez r√©essayer.";
                    return;
                }

                statusMessage.textContent = `Chargement de la collection de ${username}...`;
                cardCollectionDiv.innerHTML = ''; // Nettoyer l'affichage pr√©c√©dent

                db.collection('collections').doc(username).get()
                    .then(doc => {
                        if (!doc.exists) {
                            statusMessage.textContent = `Aucune collection trouv√©e pour ${username}. Ouvrez votre premier pack sur le stream !`;
                            return;
                        }

                        const collectionData = doc.data().cards || [];
                        const groupedCollection = groupCards(collectionData);
                        
                        // Nombre de cartes uniques dans la collection de l'utilisateur
                        const uniqueCardsCollected = Object.keys(groupedCollection).length;


                        if (uniqueCardsCollected === 0) {
                            statusMessage.textContent = `La collection de ${doc.data().username || username} est vide.`;
                            return;
                        }

                        displayCollection(groupedCollection);
                        
                        // üö® MODIFICATION DU MESSAGE DE STATUT (Total Unique / Total Catalogue) üö®
                        statusMessage.innerHTML = `
                            Collection de <strong>${doc.data().username || username}</strong> 
                            | Cartes uniques : <strong>${uniqueCardsCollected}</strong> / <strong>${TOTAL_UNIQUE_CARDS}</strong>
                            | Total de cartes tir√©es : ${collectionData.length} 
                            (ouvert en ${doc.data().totalPacks || 0} packs)
                        `;
                    })
                    .catch(error => {
                        console.error("Erreur de r√©cup√©ration Firestore:", error);
                        statusMessage.textContent = `Erreur de connexion √† la base de donn√©es: ${error.message}`;
                    });
            });

            // --- 3. FONCTIONS UTILITAIRES ---
            function groupCards(cards) {
                const grouped = {};
                cards.forEach(card => {
                    if (!grouped[card.id]) {
                        // Cherche les informations compl√®tes (dont imageUrl) dans le catalogue
                        const fullCard = cardCatalogMap[card.id]; 
                        grouped[card.id] = fullCard ? { ...fullCard, count: 0 } : { ...card, count: 0 }; 
                    }
                    grouped[card.id].count++;
                });
                return grouped;
            }

            function displayCollection(groupedCollection) {
                cardCollectionDiv.innerHTML = ''; 

                // Trier par ordre de raret√© Pok√©mon
                const sortedCards = Object.values(groupedCollection).sort((a, b) => {
                    const order = ['Rare Holo EX', 'Rare Holo', 'Rare', 'ArcEnCiel', 'Gold'];
                    return order.indexOf(a.rarity) - order.indexOf(b.rarity);
                });

                sortedCards.forEach(card => {
                    const cardElement = createCardElement(card);
                    cardCollectionDiv.appendChild(cardElement);
                });
            }

            function createCardElement(card) {
                const container = document.createElement('div');
                // Nettoyage de la raret√© pour les classes CSS: "Rare Holo EX" -> "RareHoloEX"
                const rarityClass = card.rarity ? card.rarity.replace(/ /g, '') : 'Gold'; // Fallback
                
                container.className = `card-container ${rarityClass}`; 

                const imageDiv = document.createElement('div');
                imageDiv.className = 'card-image';
                imageDiv.style.backgroundImage = `url('${card.imageUrl || 'default_pokemon.png'}')`;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'card-info';
                
                const name = document.createElement('h3');
                name.textContent = card.name;
                
                const rarity = document.createElement('p');
                rarity.textContent = `Raret√©: ${card.rarity}`;
                
                const count = document.createElement('span');
                count.className = 'card-count';
                count.textContent = `x${card.count}`;
                
                infoDiv.appendChild(name);
                infoDiv.appendChild(rarity);
                
                container.appendChild(count);
                container.appendChild(imageDiv);
                container.appendChild(infoDiv);
                
                return container;
            }

            // --- LOGIQUE DU MENU BURGER ---
            const burger = document.getElementById('burger');
            const menu = document.getElementById('menu');

            if (burger) {
                burger.addEventListener('click', () => {
                    burger.classList.toggle('open');
                    menu.classList.toggle('open');
                });
            }

            if (menu) {
                menu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        burger.classList.remove('open');
                        menu.classList.remove('open');
                    });
                });
            }
        });
    </script>
</body>
</html>




