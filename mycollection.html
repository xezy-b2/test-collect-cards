<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // Votre objet de configuration copié depuis Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAL5PZdkeN_Vo7PY2z3vT6VV79pkDuQLhE",
  authDomain: "tcg-bot-24e10.firebaseapp.com",
  projectId: "tcg-bot-24e10",
  storageBucket: "tcg-bot-24e10.firebasestorage.app",
  messagingSenderId: "825599190047",
  appId: "1:825599190047:web:006b01f7068909a1d8a12a"
};

        // Initialisation de Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Stocker la liste complète des cartes pour reconstruire les images et les informations
        let ALL_CARDS_DATA = [];
        let cardCatalogMap = {}; // Map pour la recherche rapide par ID

        document.addEventListener('DOMContentLoaded', () => {
            const usernameInput = document.getElementById('username-input');
            const loadCollectionBtn = document.getElementById('load-collection-btn');
            const statusMessage = document.getElementById('status-message');
            const cardCollectionDiv = document.getElementById('card-collection');

            // --- 1. CHARGEMENT DU CATALOGUE COMPLET (POKÉMON) ---
            async function loadCardCatalog() {
                try {
                    const response = await fetch('cards.json'); 
                    if (!response.ok) throw new Error('Fichier de catalogue cards.json non trouvé.');
                    
                    ALL_CARDS_DATA = await response.json();
                    
                    // L'ID est souvent l'index dans le JSON (commençant à 1 si le bot est bien configuré)
                    // Votre bot.js utilise l'index comme ID si l'ID n'est pas dans le JSON.
                    ALL_CARDS_DATA.forEach((card, index) => {
                        // On doit s'assurer qu'il y a un ID, comme le bot le fait
                        const cardId = card.id || String(index + 1); 
                        cardCatalogMap[cardId] = { ...card, id: cardId };
                    });
                    console.log(`Catalogue complet chargé : ${Object.keys(cardCatalogMap).length} cartes.`);
                    return true;
                } catch (error) {
                    console.error("Erreur lors du chargement du catalogue:", error);
                    statusMessage.textContent = `Erreur: Impossible de charger le fichier de cartes (cards.json).`;
                    return false;
                }
            }
            
            loadCardCatalog();


            // --- 2. FONCTION DE CHARGEMENT DE LA COLLECTION UTILISATEUR ---
            loadCollectionBtn.addEventListener('click', () => {
                const username = usernameInput.value.trim().toLowerCase();
                if (!username) {
                    statusMessage.textContent = "Veuillez entrer votre nom Twitch.";
                    return;
                }

                if (Object.keys(cardCatalogMap).length === 0) {
                    statusMessage.textContent = "Catalogue de cartes en cours de chargement ou introuvable. Veuillez réessayer.";
                    return;
                }

                statusMessage.textContent = `Chargement de la collection de ${username}...`;
                cardCollectionDiv.innerHTML = ''; // Nettoyer l'affichage précédent

                db.collection('collections').doc(username).get()
                    .then(doc => {
                        if (!doc.exists) {
                            statusMessage.textContent = `Aucune collection trouvée pour ${username}. Ouvrez votre premier pack sur le stream !`;
                            return;
                        }

                        const collectionData = doc.data().cards || [];
                        const groupedCollection = groupCards(collectionData);
                        
                        if (Object.keys(groupedCollection).length === 0) {
                            statusMessage.textContent = `La collection de ${username} est vide.`;
                            return;
                        }

                        displayCollection(groupedCollection, collectionData.length);
                        statusMessage.innerHTML = `Collection de **${doc.data().username || username}** | Total de cartes : **${collectionData.length}** (${doc.data().totalPacks || 0} packs ouverts)`;
                    })
                    .catch(error => {
                        console.error("Erreur de récupération Firestore:", error);
                        statusMessage.textContent = `Erreur de connexion à la base de données: ${error.message}`;
                    });
            });

            // --- 3. FONCTIONS UTILITAIRES ---
            function groupCards(cards) {
                const grouped = {};
                cards.forEach(card => {
                    if (!grouped[card.id]) {
                        // Cherche les informations complètes (dont imageUrl) dans le catalogue
                        const fullCard = cardCatalogMap[card.id]; 
                        // Utilise les données du catalogue si elles existent, sinon les données minimales de Firebase
                        grouped[card.id] = fullCard ? { ...fullCard, count: 0 } : { ...card, count: 0 }; 
                    }
                    grouped[card.id].count++;
                });
                return grouped;
            }

            function displayCollection(groupedCollection) {
                cardCollectionDiv.innerHTML = ''; 

                // Trier par ordre de rareté Pokémon (Rare Holo EX > Rare Holo > Rare > Uncommon > Common)
                const sortedCards = Object.values(groupedCollection).sort((a, b) => {
                    const order = ['Rare Holo EX', 'Rare Holo', 'Rare', 'Uncommon', 'Common'];
                    return order.indexOf(a.rarity) - order.indexOf(b.rarity);
                });

                sortedCards.forEach(card => {
                    const cardElement = createCardElement(card);
                    cardCollectionDiv.appendChild(cardElement);
                });
            }

            function createCardElement(card) {
                const container = document.createElement('div');
                // Nettoyage de la rareté pour les classes CSS: "Rare Holo EX" -> "RareHoloEX"
                const rarityClass = card.rarity.replace(/ /g, ''); 
                
                // On utilise les classes qui sont définies dans votre CSS (cards.html)
                container.className = `card-container ${rarityClass}`; 

                const imageDiv = document.createElement('div');
                imageDiv.className = 'card-image';
                imageDiv.style.backgroundImage = `url('${card.imageUrl || 'default_pokemon.png'}')`;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'card-info';
                
                const name = document.createElement('h3');
                name.textContent = card.name;
                
                const rarity = document.createElement('p');
                rarity.textContent = `Rareté: ${card.rarity}`;
                
                const count = document.createElement('span');
                count.className = 'card-count';
                count.textContent = `x${card.count}`;
                
                infoDiv.appendChild(name);
                infoDiv.appendChild(rarity);
                
                container.appendChild(count);
                container.appendChild(imageDiv);
                container.appendChild(infoDiv);
                
                return container;
            }

            // --- LOGIQUE DU MENU BURGER (LAISSÉE EN PLACE) ---
            const burger = document.getElementById('burger');
            const menu = document.getElementById('menu');

            if (burger) {
                burger.addEventListener('click', () => {
                    burger.classList.toggle('open');
                    menu.classList.toggle('open');
                });
            }

            if (menu) {
                menu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        burger.classList.remove('open');
                        menu.classList.remove('open');
                    });
                });
            }
        });
    </script>
