<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Collection Personnelle</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Variables du Th√®me Sombre */
        :root {
            /* Couleurs Raret√© (claires pour ressortir) */
            --color-RareHoloEX: #ff7675; /* Rouge clair pour Dark Mode */
            --color-RareHolo: #a29bfe;   /* Mauve clair */
            --color-Rare: #fdcb6e;       /* Jaune/Orange */
            --color-Uncommon: #74b9ff;   /* Bleu clair */
            --color-Common: #55efc4;     /* Vert mint */
            
            --main-bg-color: #1c1c1c;    /* Gris tr√®s fonc√© */
            --header-color: #f0f0f0;     /* Texte blanc cass√© */
            --card-bg-color: #ffffff;    /* Fond des cartes reste blanc (pour le contraste) */
            --border-color: #444444;     /* Bordure des cartes sombre */
            --accent-color: #74b9ff;     /* Bleu clair pour les accents */
            --menu-bg-color: #2c2c2c;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            background-color: var(--main-bg-color);
            color: var(--header-color);
            min-height: 100vh;
        }
        
        /* ------------------ EN-T√äTE ET MENU ------------------ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--menu-bg-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .logo a {
            color: var(--header-color);
            text-decoration: none;
            font-size: 1.5em;
            font-weight: 700;
        }

        .menu-list {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }

        .menu-list li a {
            color: var(--header-color);
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            transition: color 0.3s;
        }

        .menu-list li a:hover {
            color: var(--accent-color);
        }

        .burger-icon {
            display: none;
            cursor: pointer;
        }

        .bar {
            width: 25px;
            height: 3px;
            background-color: var(--header-color);
            margin: 5px 0;
            transition: 0.4s;
        }

        /* ------------------ FORMULAIRE DE RECHERCHE ------------------ */
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #username-input {
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--menu-bg-color);
            color: var(--header-color);
            flex-grow: 1;
            border-radius: 5px;
        }

        #load-collection-btn {
            padding: 10px 20px;
            border: none;
            background-color: var(--accent-color);
            color: var(--main-bg-color);
            font-weight: 700;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #load-collection-btn:hover {
            background-color: #5aa6f5;
        }

        #status-message {
            margin-top: 0;
            font-style: italic;
            color: #ccc;
        }

        /* ------------------ AFFICHAGE DES CARTES ------------------ */
        #card-collection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card-container {
            position: relative;
            background-color: var(--card-bg-color);
            border: 5px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
            cursor: default;
        }
        
        .card-container:hover {
            transform: translateY(-5px);
        }

        .card-image {
            width: 100%;
            padding-top: 100%; /* Ratio 1:1 pour les images, vous pouvez ajuster */
            background-size: cover;
            background-position: center;
            background-color: #333; /* Couleur par d√©faut si l'image est manquante */
        }

        .card-info {
            padding: 10px;
            color: #333; /* Texte sombre sur fond de carte clair */
            text-align: center;
            flex-grow: 1;
        }

        .card-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            font-weight: 700;
        }

        .card-info p {
            margin: 0;
            font-size: 0.9em;
            font-style: italic;
        }

        /* COMPTEUR DE CARTES */
        .card-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 700;
            z-index: 10;
        }

        /* ------------------ COULEURS DE RARET√â ------------------ */
        .RareHoloEX {
            border-color: var(--color-RareHoloEX);
        }
        .RareHolo {
            border-color: var(--color-RareHolo);
        }
        .Rare {
            border-color: var(--color-Rare);
        }
        .Uncommon {
            border-color: var(--color-Uncommon);
        }
        .Common {
            border-color: var(--color-Common);
        }
        
        /* ------------------ RESPONSIVE MENU ------------------ */
        @media (max-width: 768px) {
            .menu-list {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px; /* Hauteur du header */
                left: 0;
                width: 100%;
                background-color: var(--menu-bg-color);
                box-shadow: 0 2px 10px rgba(0,0,0,0.5);
                z-index: 20;
            }

            .menu-list.open {
                display: flex;
            }

            .menu-list li {
                text-align: center;
                border-top: 1px solid #444;
            }

            .burger-icon {
                display: none;
            }

            .burger-icon.open .bar:nth-child(1) {
                transform: rotate(-45deg) translate(-5px, 6px);
            }
            .burger-icon.open .bar:nth-child(2) {
                opacity: 0;
            }
            .burger-icon.open .bar:nth-child(3) {
                transform: rotate(45deg) translate(-5px, -6px);
            }
        }
    </style>

    <script>
        // Votre objet de configuration copi√© depuis Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAL5PZdkeN_Vo7PY2z3vT6VV79pkDuQLhE",
  authDomain: "tcg-bot-24e10.firebaseapp.com",
  projectId: "tcg-bot-24e10",
  storageBucket: "tcg-bot-24e10.firebasestorage.app",
  messagingSenderId: "825599190047",
  appId: "1:825599190047:web:006b01f7068909a1d8a12a"
};

        // Initialisation de Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Stocker la liste compl√®te des cartes pour reconstruire les images et les informations
        let ALL_CARDS_DATA = [];
        let cardCatalogMap = {}; // Map pour la recherche rapide par ID
        let TOTAL_UNIQUE_CARDS = 0; // üëà NOUVEAU : Total des cartes disponibles dans le catalogue

        document.addEventListener('DOMContentLoaded', () => {
            const usernameInput = document.getElementById('username-input');
            const loadCollectionBtn = document.getElementById('load-collection-btn');
            const statusMessage = document.getElementById('status-message');
            const cardCollectionDiv = document.getElementById('card-collection');

            // --- 1. CHARGEMENT DU CATALOGUE COMPLET (POK√âMON) ---
            async function loadCardCatalog() {
                try {
                    // NOTE: Assurez-vous que le nom du fichier ici correspond √† votre catalogue (cards.json ou ectoplasma_cards.json)
                    const response = await fetch('cards.json'); 
                    if (!response.ok) throw new Error('Fichier de catalogue cards.json non trouv√©.');
                    
                    ALL_CARDS_DATA = await response.json();
                    
                    // üö® D√âFINITION DU TOTAL UNIQUE DE CARTES üö®
                    TOTAL_UNIQUE_CARDS = ALL_CARDS_DATA.length;
                    
                    // Construit la map pour la recherche rapide par ID
                    ALL_CARDS_DATA.forEach((card, index) => {
                        const cardId = card.id || String(index + 1); 
                        cardCatalogMap[cardId] = { ...card, id: cardId };
                    });
                    console.log(`Catalogue complet charg√© : ${Object.keys(cardCatalogMap).length} cartes.`);
                    return true;
                } catch (error) {
                    console.error("Erreur lors du chargement du catalogue:", error);
                    statusMessage.textContent = `Erreur: Impossible de charger le fichier de cartes (cards.json).`;
                    return false;
                }
            }
            
            // Lancer le chargement du catalogue
            loadCardCatalog();


            // --- 2. FONCTION DE CHARGEMENT DE LA COLLECTION UTILISATEUR ---
            loadCollectionBtn.addEventListener('click', () => {
                const username = usernameInput.value.trim().toLowerCase();
                if (!username) {
                    statusMessage.textContent = "Veuillez entrer votre nom Twitch.";
                    return;
                }

                if (TOTAL_UNIQUE_CARDS === 0) { // V√©rifie la variable charg√©e
                    statusMessage.textContent = "Catalogue de cartes en cours de chargement ou introuvable. Veuillez r√©essayer.";
                    return;
                }

                statusMessage.textContent = `Chargement de la collection de ${username}...`;
                cardCollectionDiv.innerHTML = ''; // Nettoyer l'affichage pr√©c√©dent

                db.collection('collections').doc(username).get()
                    .then(doc => {
                        if (!doc.exists) {
                            statusMessage.textContent = `Aucune collection trouv√©e pour ${username}. Ouvrez votre premier pack sur le stream !`;
                            return;
                        }

                        const collectionData = doc.data().cards || [];
                        const groupedCollection = groupCards(collectionData);
                        
                        // Nombre de cartes uniques dans la collection de l'utilisateur
                        const uniqueCardsCollected = Object.keys(groupedCollection).length;

                        if (uniqueCardsCollected === 0) {
                            statusMessage.textContent = `La collection de ${doc.data().username || username} est vide.`;
                            return;
                        }

                        displayCollection(groupedCollection);
                        
                        // üö® MODIFICATION DU MESSAGE DE STATUT (Total Unique / Total Catalogue) üö®
                        statusMessage.innerHTML = `
                            Collection de **${doc.data().username || username}** | Cartes uniques : <strong>${uniqueCardsCollected}</strong> / <strong>${TOTAL_UNIQUE_CARDS}</strong>
                            | Total de cartes tir√©es : ${collectionData.length} 
                            (ouvert en ${doc.data().totalPacks || 0} packs)
                        `;
                    })
                    .catch(error => {
                        console.error("Erreur de r√©cup√©ration Firestore:", error);
                        statusMessage.textContent = `Erreur de connexion √† la base de donn√©es: ${error.message}`;
                    });
            });

            // --- 3. FONCTIONS UTILITAIRES ---
            function groupCards(cards) {
                const grouped = {};
                cards.forEach(card => {
                    if (!grouped[card.id]) {
                        // Cherche les informations compl√®tes (dont imageUrl) dans le catalogue
                        const fullCard = cardCatalogMap[card.id]; 
                        // Utilise les donn√©es du catalogue si elles existent, sinon les donn√©es minimales de Firebase
                        grouped[card.id] = fullCard ? { ...fullCard, count: 0 } : { ...card, count: 0 }; 
                    }
                    grouped[card.id].count++;
                });
                return grouped;
            }

            function displayCollection(groupedCollection) {
                cardCollectionDiv.innerHTML = ''; 

                // Trier par ordre de raret√© Pok√©mon (Rare Holo EX > Rare Holo > Rare > Uncommon > Common)
                const sortedCards = Object.values(groupedCollection).sort((a, b) => {
                    const order = ['Rare Holo EX', 'Rare Holo', 'Rare', 'Uncommon', 'Common'];
                    // On utilise le 'rarity' stock√© dans l'objet de la carte, qui vient du catalogue
                    return order.indexOf(a.rarity) - order.indexOf(b.rarity);
                });

                sortedCards.forEach(card => {
                    const cardElement = createCardElement(card);
                    cardCollectionDiv.appendChild(cardElement);
                });
            }

            function createCardElement(card) {
                const container = document.createElement('div');
                // Nettoyage de la raret√© pour les classes CSS: "Rare Holo EX" -> "RareHoloEX"
                const rarityClass = card.rarity ? card.rarity.replace(/ /g, '') : 'Unknown'; 
                
                // On utilise les classes qui sont d√©finies dans votre CSS (cards.html)
                container.className = `card-container ${rarityClass}`; 

                const imageDiv = document.createElement('div');
                imageDiv.className = 'card-image';
                // Utilise le chemin local si vous avez t√©l√©charg√© les images, sinon le lien externe
                imageDiv.style.backgroundImage = `url('${card.imageUrl || 'default_pokemon.png'}')`;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'card-info';
                
                const name = document.createElement('h3');
                name.textContent = card.name || 'Carte Inconnue';
                
                const rarity = document.createElement('p');
                rarity.textContent = `Raret√©: ${card.rarity || 'Inconnue'}`;
                
                const count = document.createElement('span');
                count.className = 'card-count';
                count.textContent = `x${card.count}`;
                
                infoDiv.appendChild(name);
                infoDiv.appendChild(rarity);
                
                container.appendChild(count);
                container.appendChild(imageDiv);
                container.appendChild(infoDiv);
                
                return container;
            }

            // --- LOGIQUE DU MENU BURGER ---
            const burger = document.getElementById('burger');
            const menu = document.getElementById('menu');

            if (burger) {
                burger.addEventListener('click', () => {
                    burger.classList.toggle('open');
                    menu.classList.toggle('open');
                });
            }

            if (menu) {
                menu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        burger.classList.remove('open');
                        menu.classList.remove('open');
                    });
                });
            }
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="logo"><a href="index.html">TCG Bot</a></div>
        <div class="burger-icon" id="burger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <ul class="menu-list" id="menu">
            <li><a href="index.html">Accueil</a></li>
            <li><a href="cards.html">Cartes √† Collectionner (151)</a></li>
            <li><a href="mycollection.html">Mes Cartes (Collection Personnelle)</a></li>
        </ul>
    </header>
    <div class="content">
        <h1>Ma Collection Personnelle</h1>

        <div class="search-form">
            <input type="text" id="username-input" placeholder="Entrez votre nom Twitch..." />
            <button id="load-collection-btn">Charger ma collection</button>
        </div>

        <p id="status-message">Entrez votre nom Twitch pour voir les cartes que vous avez tir√©es.</p>

        <div id="card-collection">
            </div>
    </div>
</body>
</html>
