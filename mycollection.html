<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Collection Personnelle</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Variables du Th√®me Sombre */
        :root {
            /* Couleurs Raret√© (claires pour ressortir) */
            --color-RareHoloEX: #ff7675; /* Rouge clair pour Dark Mode */
            --color-RareHolo: #a29bfe;   /* Mauve clair */
            --color-Rare: #fdcb6e;       /* Jaune/Orange */
            --color-Uncommon: #74b9ff;   /* Bleu clair */
            --color-Common: #55efc4;     /* Vert mint */
            
            --main-bg-color: #1c1c1c;    /* Gris tr√®s fonc√© */
            --header-color: #f0f0f0;     /* Texte blanc cass√© */
            --card-bg-color: #ffffff;    /* Fond des cartes reste blanc (pour le contraste) */
            --border-color: #444444;     /* Bordure des cartes sombre */
            --accent-color: #74b9ff;     /* Bleu clair pour les accents */
            --menu-bg-color: #2c2c2c;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            background-color: var(--main-bg-color);
            color: var(--header-color);
            min-height: 100vh;
        }
        
        /* ------------------ EN-T√äTE ET MENU ------------------ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--menu-bg-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .logo a {
            color: var(--header-color);
            text-decoration: none;
            font-size: 1.5em;
            font-weight: 700;
        }

        .menu-list {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }

        .menu-list li a {
            color: var(--header-color);
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            transition: color 0.3s;
        }

        .menu-list li a:hover {
            color: var(--accent-color);
        }

        .burger-icon {
            display: none;
            cursor: pointer;
        }

        .bar {
            width: 25px;
            height: 3px;
            background-color: var(--header-color);
            margin: 5px 0;
            transition: 0.4s;
        }

        /* ------------------ FORMULAIRE DE RECHERCHE ------------------ */
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #username-input {
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--menu-bg-color);
            color: var(--header-color);
            flex-grow: 1;
            border-radius: 5px;
        }

        #load-collection-btn {
            padding: 10px 20px;
            border: none;
            background-color: var(--accent-color);
            color: var(--main-bg-color);
            font-weight: 700;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #load-collection-btn:hover {
            background-color: #5aa6f5;
        }

        #status-message {
            margin-top: 0;
            font-style: italic;
            color: #ccc;
        }

        /* ------------------ AFFICHAGE DES CARTES ------------------ */
        #card-collection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card-container {
            position: relative;
            background-color: var(--card-bg-color);
            border: 5px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
            cursor: default;
        }
        
        .card-container:hover {
            transform: translateY(-5px);
        }

        .card-image {
            width: 100%;
            padding-top: 100%; /* Ratio 1:1 pour les images, vous pouvez ajuster */
            background-size: cover;
            background-position: center;
            background-color: #333; /* Couleur par d√©faut si l'image est manquante */
        }

        .card-info {
            padding: 10px;
            color: #333; /* Texte sombre sur fond de carte clair */
            text-align: center;
            flex-grow: 1;
        }

        .card-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            font-weight: 700;
        }

        .card-info p {
            margin: 0;
            font-size: 0.9em;
            font-style: italic;
        }

        /* COMPTEUR DE CARTES (Nouveau style) */
        .card-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 700;
            z-index: 10;
        }

        /* ------------------ COULEURS DE RARET√â ------------------ */
        .RareHoloEX {
            border-color: var(--color-RareHoloEX);
        }
        .RareHolo {
            border-color: var(--color-RareHolo);
        }
        .Rare {
            border-color: var(--color-Rare);
        }
        .Uncommon {
            border-color: var(--color-Uncommon);
        }
        .Common {
            border-color: var(--color-Common);
        }
        
        /* ------------------ RESPONSIVE MENU ------------------ */
        @media (max-width: 768px) {
            .menu-list {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px; /* Hauteur du header */
                left: 0;
                width: 100%;
                background-color: var(--menu-bg-color);
                box-shadow: 0 2px 10px rgba(0,0,0,0.5);
                z-index: 20;
            }

            .menu-list.open {
                display: flex;
            }

            .menu-list li {
                text-align: center;
                border-top: 1px solid #444;
            }

            .burger-icon {
                display: block;
            }

            .burger-icon.open .bar:nth-child(1) {
                transform: rotate(-45deg) translate(-5px, 6px);
            }
            .burger-icon.open .bar:nth-child(2) {
                opacity: 0;
            }
            .burger-icon.open .bar:nth-child(3) {
                transform: rotate(45deg) translate(-5px, -6px);
            }
        }
    </style>

    <script>
        // Votre objet de configuration copi√© depuis Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAL5PZdkeN_Vo7PY2z3vT6VV79pkDuQLhE",
  authDomain: "tcg-bot-24e10.firebaseapp.com",
  projectId: "tcg-bot-24e10",
  storageBucket: "tcg-bot-24e10.firebasestorage.app",
  messagingSenderId: "825599190047",
  appId: "1:825599190047:web:006b01f7068909a1d8a12a"
};

        // Initialisation de Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Stocker la liste compl√®te des cartes pour reconstruire les images et les informations
        let ALL_CARDS_DATA = [];
        let cardCatalogMap = {}; // Map pour la recherche rapide par ID

        /**
         * Construit une map pour un acc√®s rapide aux informations compl√®tes des cartes par ID.
         * @param {Array} cards - Le catalogue complet des cartes.
         */
        function buildCardCatalogMap(cards) {
            cardCatalogMap = cards.reduce((map, card) => {
                // S'assure que l'ID est une cha√Æne de caract√®res pour la coh√©rence
                map[String(card.id)] = card; 
                return map;
            }, {});
            console.log(`Map de catalogue construite avec ${Object.keys(cardCatalogMap).length} entr√©es.`);
        }

        /**
         * Charge le fichier cards.json et construit le catalogue en m√©moire.
         */
        async function loadCardCatalog() {
            try {
                const response = await fetch('./cards.json');
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                ALL_CARDS_DATA = await response.json();
                
                // üö® CRITIQUE : Construction de la map apr√®s le chargement du catalogue
                buildCardCatalogMap(ALL_CARDS_DATA); 
                
                console.log(`Catalogue complet charg√© : ${ALL_CARDS_DATA.length} cartes.`);
                return ALL_CARDS_DATA;
            } catch (error) {
                console.error('Erreur: Impossible de charger le fichier de cartes (cards.json).', error);
                return [];
            }
        }
        
        /**
         * R√©cup√®re la collection de cartes pour l'utilisateur sp√©cifi√© depuis Firebase.
         * @param {string} username - Le nom d'utilisateur.
         */
        async function getCollectionFromFirebase(username) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = `Chargement de la collection de ${username}...`;
            
            try {
                // Chemin d'acc√®s dans la base de donn√©es : 'collections/{username}'
                const docRef = db.collection('collections').doc(username.toLowerCase());
                const doc = await docRef.get();

                if (!doc.exists) {
                    statusMessage.textContent = `La collection de ${username} est vide ou n'existe pas.`;
                    return [];
                }

                // La collection est un objet JSON o√π les cl√©s sont les IDs des cartes
                const collectionData = doc.data(); 
                
                // Convertir l'objet de collection en un tableau de cartes, incluant le COUNT
                const cardsArray = Object.keys(collectionData).map(cardId => ({
                    id: String(cardId), // Assure que l'ID est une cha√Æne
                    count: collectionData[cardId].count || 1 
                }));

                return cardsArray;

            } catch (error) {
                console.error("Erreur de r√©cup√©ration de la collection:", error);
                statusMessage.textContent = `Erreur de connexion √† la base de donn√©es.`;
                return [];
            }
        }

        /**
         * Affiche les cartes dans la section #card-collection.
         * @param {Array} cardsFromFirebase - Les donn√©es de collection (ID et COUNT) de Firebase.
         */
        function displayCollection(cardsFromFirebase) {
            const cardCollectionDiv = document.getElementById('card-collection');
            const statusMessage = document.getElementById('status-message');
            cardCollectionDiv.innerHTML = '';
            
            if (cardsFromFirebase.length === 0) {
                statusMessage.textContent = "Collection charg√©e (0 cartes).";
                return;
            }

            let totalCount = cardsFromFirebase.reduce((sum, card) => sum + card.count, 0);
            statusMessage.textContent = `Collection charg√©e : ${cardsFromFirebase.length} cartes uniques, ${totalCount} cartes au total.`;

            cardsFromFirebase.forEach(firebaseCard => {
                
                // üö® POINT CRITIQUE : on r√©cup√®re les infos compl√®tes de l'image depuis la map !
                const completeCardInfo = cardCatalogMap[firebaseCard.id];
                
                if (completeCardInfo) {
                    // Cr√©er un objet fusionn√© pour l'affichage (avec l'URL et le COUNT)
                    const cardToDisplay = {
                        ...completeCardInfo, // Infos du catalogue (id, name, rarity, imageUrl)
                        count: firebaseCard.count // Count de Firebase
                    };
                    const cardElement = createCardElement(cardToDisplay);
                    cardCollectionDiv.appendChild(cardElement);
                } else {
                    // Si la carte n'est pas trouv√©e (Erreur ou ID inconnu), afficher un placeholder
                    const placeholder = document.createElement('div');
                    placeholder.className = 'card-container Unknown';
                    placeholder.innerHTML = `
                        <div class="card-image" style="background-image: url('default_pokemon.png');"></div>
                        <div class="card-info">
                            <h3>ID Inconnu: ${firebaseCard.id}</h3>
                            <p>Raret√©: Inconnue</p>
                        </div>
                        <span class="card-count">x${firebaseCard.count}</span>
                    `;
                    cardCollectionDiv.appendChild(placeholder);
                }
            });
        }

        /**
         * Cr√©e l'√©l√©ment DOM pour une seule carte.
         * @param {object} card - L'objet carte complet (y compris l'imageUrl).
         */
        function createCardElement(card) {
            const container = document.createElement('div');
            
            // Nettoyage de la raret√© pour les noms de classes (ex: "Rare Holo EX" devient "RareHoloEX")
            const rarityClass = card.rarity.replace(/ /g, ''); 
            container.className = `card-container ${rarityClass}`; 

            const imageDiv = document.createElement('div');
            imageDiv.className = 'card-image';
            // üö® MODIFICATION CRITIQUE : Utilise DIRECTEMENT card.imageUrl
            imageDiv.style.backgroundImage = `url('${card.imageUrl || 'default_pokemon.png'}')`; 
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'card-info';
            
            const name = document.createElement('h3');
            name.textContent = card.name;
            
            const rarity = document.createElement('p');
            rarity.textContent = `Raret√©: ${card.rarity}`;
            
            const count = document.createElement('span');
            count.className = 'card-count';
            count.textContent = `x${card.count}`;
            
            infoDiv.appendChild(name);
            infoDiv.appendChild(rarity);
            
            container.appendChild(count);
            container.appendChild(imageDiv);
            container.appendChild(infoDiv);
            
            return container;
        }


        // ------------------ LOGIQUE PRINCIPALE ------------------
        document.addEventListener('DOMContentLoaded', async () => {
            const usernameInput = document.getElementById('username-input');
            const loadCollectionBtn = document.getElementById('load-collection-btn');
            
            // 1. Chargement initial du catalogue de cartes
            await loadCardCatalog();

            // 2. √âv√©nement du bouton de chargement
            loadCollectionBtn.addEventListener('click', async () => {
                const username = usernameInput.value.trim().toLowerCase();
                if (username) {
                    const cards = await getCollectionFromFirebase(username);
                    displayCollection(cards);
                } else {
                    document.getElementById('status-message').textContent = "Veuillez entrer un nom d'utilisateur.";
                }
            });


            // --- LOGIQUE DU MENU BURGER (LAISS√âE EN PLACE) ---
            const burger = document.getElementById('burger');
            const menu = document.getElementById('menu');

            if (burger) {
                burger.addEventListener('click', () => {
                    burger.classList.toggle('open');
                    menu.classList.toggle('open');
                });
            }

            if (menu) {
                menu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        burger.classList.remove('open');
                        menu.classList.remove('open');
                    });
                });
            }
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="logo"><a href="index.html">TCG Bot</a></div>
        <div class="burger-icon" id="burger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <ul class="menu-list" id="menu">
            <li><a href="index.html">Accueil</a></li>
            <li><a href="cards.html">Cartes √† Collectionner (151)</a></li>
            <li><a href="mycollection.html">Mes Cartes (Collection Personnelle)</a></li>
        </ul>
    </header>
    <div class="content">
        <h1>Ma Collection Personnelle</h1>

        <div class="search-form">
            <input type="text" id="username-input" placeholder="Entrez votre nom Twitch..." />
            <button id="load-collection-btn">Charger ma collection</button>
        </div>

        <p id="status-message">Entrez votre nom Twitch pour voir les cartes que vous avez tir√©es.</p>

        <div id="card-collection">
            </div>
    </div>
</body>
</html>
